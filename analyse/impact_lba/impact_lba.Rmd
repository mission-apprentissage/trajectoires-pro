---
title: "Impact LBA - Mai 2024"
subtitle: "Document de travail"
date: "Mai 2024"
output: 
    html_document:
      keep_md: yes
      toc: true
      toc_float:
        toc_collapsed: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,error = FALSE,message = FALSE)

library(readxl)
library(tidyverse)
library(jsonlite)
library(rpart)
library(rpart.plot)
library(flextable)

source("../../../../0- data/.env")

#Pour import trafic, cf. script_import_trafic_lba.R
data_trafic_lba_1_init <- readRDS("../../../../0- data/LBA/plausible/data_trafic_lba_from_1_02_2023_to_28_04_2023.rds")
data_trafic_lba_2_init <- readRDS("../../../../0- data/LBA/plausible/data_trafic_lba_from_1_02_2024_to_28_04_2024.rds")

data_dde_rdv_lba_1_init <- read_excel("../../../../0- data/LBA/query_result_2024-01-25T09_54_40.711397+01_00.xlsx")
data_dde_rdv_lba_2_init <- read_excel("../../../../0- data/LBA/2024 Appointments LBA.xlsx")

ROME_ArboPrincipale <- read_excel("../../../../Groupe-000 - Divers/000 - 7 - Impact LBA/data/ROME_ArboPrincipale.xlsx", 
                                  sheet = "Arbo Principale 14-06-2021")

ROME <- ROME_ArboPrincipale %>% 
  select(1:3) %>% 
  drop_na() %>% 
  distinct() %>% 
  setNames(c("R1","R2","R3")) %>% 
  mutate(
    ROME=glue::glue("{R1}{R2}{R3}")
  )

formation_catalogue_apprentissage <- read_csv2("../../../../0- data/RCO/formation_2024-05-02T07 56 05.492Z.csv")

formation_catalogue_apprentissage <- formation_catalogue_apprentissage %>% 
  mutate_all(str_remove_all,"=\"") %>% 
  mutate_all(str_remove_all,"\"")

formation_catalogue_apprentissage_long <- formation_catalogue_apprentissage %>% 
  # select(`UAI Responsable`,`UAI formation`,`UAI formateur`,`Code du diplome ou du titre suivant la nomenclature de l'Education nationale (CodeEN)`,`Clé ministere educatif`,Region,Tags) %>%
  select(`Responsable: UAI`,`Lieu: UAI`,`Formateur: UAI`,`Formation: code CFD`,`Clé ministere educatif`,`Lieu: région`,`Offre: Tags`,`Offre: Capacite`) %>% 
  setNames(c("UAI Responsable","UAI formation","UAI formateur","Code du diplome ou du titre suivant la nomenclature de l'Education nationale (CodeEN)","Clé ministere educatif","Region","Tags","Capacite")) %>% 
  pivot_longer(cols = contains("Uai"),names_to = "Type UAI",values_to = "UAI",values_drop_na = TRUE)

n_formation_diplome <- read_delim("../../../../0- data/BCN/n_formation_diplome_.csv",delim = ";", escape_double = FALSE, trim_ws = TRUE)
n_niveau_formation_diplome <- read_csv2("../../../../0- data/BCN/n_niveau_formation_diplome_.csv")

### Région ----

data <-
  fromJSON(
    paste0("https://exposition-sandbox.inserjeunes.beta.gouv.fr/api/inserjeunes/regionales?millesimes=2021_2022&apiKey=",infos_utilisateurs$api_expo_sandbox$apikey,"&items_par_page=999999")
  )

data_meta_regionalesStats <- data$regionales %>%
  as_tibble() %>% 
  mutate(
    code_certification_source = data$regionales$donnee_source$code_certification,
    type_source = data$regionales$donnee_source$type,
    code_region = data$regionales$region$code,
    nom_region = data$regionales$region$nom
  )  

data_meta_regionalesStats <- data_meta_regionalesStats %>% 
  mutate(
    Avant_apres_continuum = case_when(
      nb_annee_term < 20 ~ "Sous le seuil de 20 élèves",
      type_source %in% c("self","nouvelle") ~ "Avant continuum",
      type_source == "ancienne" ~ "Apres continuum"
    )
  )


data_trafic_lba_1 <- data_trafic_lba_1_init %>% 
  filter(!is.na(name)) %>% 
  distinct() %>% 
  mutate(name=str_split_i(name," - ",1)) %>% 
  rename(`Cle Ministere Educatif`=name) %>% 
  select(`Cle Ministere Educatif`,visitors) %>% 
  setNames(c("Cle Ministere Educatif","visiteurs")) %>% 
  mutate(Periode=2023) %>% 
  left_join(
    formation_catalogue_apprentissage_long %>% 
      select(`Clé ministere educatif`,`UAI`,`Type UAI`,Region,Tags),
    by=c("Cle Ministere Educatif"="Clé ministere educatif")
  ) %>% 
  mutate(
    `Type UAI`=factor(`Type UAI`,levels=c("UAI formation","UAI formateur","UAI Responsable"))
  ) %>% 
  mutate(presence=ifelse(str_detect(Tags,"2023")&str_detect(Tags,"2024"),"2023-2024","2023")) %>% 
  group_by(`Cle Ministere Educatif`) %>% 
  filter(as.numeric(`Type UAI`)==min(as.numeric(`Type UAI`))) %>% 
  ungroup()
  

data_trafic_lba_2 <- data_trafic_lba_2_init %>% 
  filter(!is.na(name)) %>% 
  distinct() %>% 
  mutate(name=str_split_i(name," - ",1)) %>% 
  rename(`Cle Ministere Educatif`=name) %>% 
  select(`Cle Ministere Educatif`,visitors) %>% 
  setNames(c("Cle Ministere Educatif","visiteurs")) %>% 
  mutate(Periode=2024) %>% 
  left_join(
    formation_catalogue_apprentissage_long %>% 
      select(`Clé ministere educatif`,`UAI`,`Type UAI`,Region,Tags),
    by=c("Cle Ministere Educatif"="Clé ministere educatif")
  ) %>% 
  mutate(
    `Type UAI`=factor(`Type UAI`,levels=c("UAI formation","UAI formateur","UAI Responsable"))
  ) %>% 
  mutate(presence=ifelse(str_detect(Tags,"2023")&str_detect(Tags,"2024"),"2023-2024","2023")) %>% 
  group_by(`Cle Ministere Educatif`) %>% 
  filter(as.numeric(`Type UAI`)==min(as.numeric(`Type UAI`))) %>% 
  ungroup()





data_trafic_lba_1_2 <- data_trafic_lba_1 %>% 
  bind_rows(data_trafic_lba_2)

data_dde_rdv_lba_1 <- data_dde_rdv_lba_1_init %>% 
  mutate(`Created At`=as.Date(`Created At`)) %>% 
  filter(`Created At`>="2023-02-01" & `Created At`<="2023-04-28") %>% 
  filter(!is.na(`Formationcatalogues → Cfd`)&!is.na(`Formationcatalogues → Etablissement Formateur Uai`)) %>% 
  distinct() %>% 
  setNames(c("Cle Ministere Educatif","Created At","CFD","UAI")) %>% 
  mutate(Periode=2023) %>% 
  select(-UAI) %>% 
  left_join(
    formation_catalogue_apprentissage_long %>% 
      select(`Clé ministere educatif`,`UAI`,`Type UAI`,Region,Tags),
    by=c("Cle Ministere Educatif"="Clé ministere educatif")
  ) %>% 
  mutate(
    `Type UAI`=factor(`Type UAI`,levels=c("UAI formation","UAI formateur","UAI Responsable"))
  ) %>% 
  mutate(presence=ifelse(str_detect(Tags,"2023")&str_detect(Tags,"2024"),"2023-2024","2023")) %>% 
  group_by(`Cle Ministere Educatif`) %>% 
  filter(as.numeric(`Type UAI`)==min(as.numeric(`Type UAI`))) %>% 
  ungroup()

data_dde_rdv_lba_2 <- data_dde_rdv_lba_2_init %>% 
  mutate(`Created At`=as.Date(`Created At`)) %>% 
  filter(`Appointment Origin`=="LBA") %>% 
  filter(`Created At`>="2024-02-01" & `Created At`<="2024-04-28")%>% 
  filter(!is.na(`Formationcatalogues - Cle Ministere Educatif → Cfd`)&!is.na(`Formationcatalogues - Cle Ministere Educatif → Etablissement Formateur Uai`)) %>% 
  distinct() %>% 
  select(`Cle Ministere Educatif`,`Created At`,`Formationcatalogues - Cle Ministere Educatif → Cfd`,`Formationcatalogues - Cle Ministere Educatif → Etablissement Formateur Uai`) %>% 
  setNames(c("Cle Ministere Educatif","Created At","CFD","UAI")) %>% 
  mutate(Periode=2024)   %>% 
  select(-UAI) %>% 
  left_join(
    formation_catalogue_apprentissage_long %>% 
      select(`Clé ministere educatif`,`UAI`,`Type UAI`,Region,Tags),
    by=c("Cle Ministere Educatif"="Clé ministere educatif")
  ) %>% 
  mutate(
    `Type UAI`=factor(`Type UAI`,levels=c("UAI formation","UAI formateur","UAI Responsable"))
  ) %>% 
  mutate(presence=ifelse(str_detect(Tags,"2023")&str_detect(Tags,"2024"),"2023-2024","2024")) %>% 
  group_by(`Cle Ministere Educatif`) %>% 
  filter(as.numeric(`Type UAI`)==min(as.numeric(`Type UAI`))) %>% 
  ungroup()

data_dde_rdv_lba_1_2 <- data_dde_rdv_lba_1 %>% 
  bind_rows(data_dde_rdv_lba_2)

data_trafic_dde_rdv_lba_1_2 <- data_dde_rdv_lba_1_2   %>% 
  group_by(Periode,Region,CFD,presence,`Cle Ministere Educatif`) %>% 
  summarise(RDV=n()) %>% 
  ungroup() %>% 
  select(Periode,Region,CFD,RDV,presence,`Cle Ministere Educatif`) %>% 
  full_join(
    data_trafic_lba_1_2 %>% 
      select(-UAI,-`Type UAI`,-Tags) %>% 
      group_by(`Cle Ministere Educatif`,Periode,Region,presence) %>%
      summarise(visiteurs=sum(visiteurs)),
    by=c("Cle Ministere Educatif","Periode","Region","presence" )
  ) %>% 
  mutate_at(vars(RDV),replace_na,0) %>% 
  filter(!is.na(visiteurs)) %>% 
  left_join(
    formation_catalogue_apprentissage %>% 
      select(`Clé ministere educatif`,`Formation: code CFD`) %>% 
      setNames(c("Cle Ministere Educatif","CFD_verif")),
    by="Cle Ministere Educatif"
  ) %>% 
  mutate(
    CFD=case_when(
      !is.na(CFD)~CFD,
      TRUE~CFD_verif
    )) %>%
  select(-CFD_verif) 



stats_lba_cle_rdv <- data_trafic_dde_rdv_lba_1_2   %>% 
  group_by(Periode,Region,CFD,presence,`Cle Ministere Educatif`) %>% 
  summarise(visiteurs=sum(visiteurs)) %>% 
  select(Periode,Region,CFD,visiteurs,presence,`Cle Ministere Educatif`)  %>% 
  setNames(c("Periode","Region","CFD","visiteurs","Presence","Cle Ministere Educatif")) %>%   
  mutate(Periode=paste0(Periode," - visiteurs")) %>% 
  pivot_wider(
    names_from = Periode,values_from = visiteurs
  ) %>% 
  left_join(
    data_trafic_dde_rdv_lba_1_2   %>% 
      group_by(Periode,Region,CFD,presence,`Cle Ministere Educatif`) %>% 
      summarise(RDV=sum(RDV)) %>% 
      select(Periode,Region,CFD,RDV,presence,`Cle Ministere Educatif`)  %>% 
      setNames(c("Periode","Region","CFD","RDV","Presence","Cle Ministere Educatif")) %>%   
      mutate(Periode=paste0(Periode," - RDV")) %>% 
      pivot_wider(
        names_from = Periode,values_from = RDV
      ),
    by=c( "Region","CFD","Presence","Cle Ministere Educatif")
  ) %>% 
  left_join(
    data_meta_regionalesStats %>% 
      filter(filiere=="apprentissage") %>% 
      select(code_certification,nom_region,nb_annee_term,taux_en_emploi_6_mois,taux_en_formation) ,
    by=c("Region"="nom_region","CFD"="code_certification")
  ) %>% 
  mutate(
    NIVEAU_FORMATION_DIPLOME=str_sub(CFD,1,3)
  ) %>% 
  left_join(
    n_niveau_formation_diplome %>%
      mutate(NIVEAU_QUALIFICATION_RNCP=ifelse(NIVEAU_FORMATION_DIPLOME=="010",4,NIVEAU_QUALIFICATION_RNCP)) %>% 
      select(NIVEAU_FORMATION_DIPLOME,NIVEAU_QUALIFICATION_RNCP),
    by="NIVEAU_FORMATION_DIPLOME"
  ) %>% 
  mutate(
    type_formation=case_when(
      as.numeric(NIVEAU_QUALIFICATION_RNCP)%in%0:4 ~ "Avant le bac",
      as.numeric(NIVEAU_QUALIFICATION_RNCP)%in%5:8 ~ "Après le bac"
    ),
    affichage_ij_2024=ifelse(is.na(nb_annee_term)| nb_annee_term <20,F,T)) %>% 
  ungroup() %>% 
  mutate_at(vars(c(`2023 - visiteurs`,`2024 - visiteurs`,`2023 - RDV`,`2024 - RDV`)),replace_na,0) %>% 
  mutate(
    type_formation=factor(type_formation,levels=c("Avant le bac","Après le bac")),
    group_taux_en_emploi_6_mois=cut(taux_en_emploi_6_mois,
                                    breaks = c(0,30,100),
                                    labels = c("Taux en emploi à 6 mois inférieur à 30%",
                                               "Taux en emploi à 6 mois supérieur à 30%"
                                    ),
                                    # breaks = c(0,24,58,100),
                                    # labels=c("Zone de certitude","Zone d'incertitude","Zone de certitude"),
                                    include.lowest = TRUE),
    group_taux_en_formation=cut(taux_en_formation,
                                breaks = c(0,24,100),
                                labels = c("Taux en formation inférieur à 24%",
                                           "Taux en formation supérieur à 24%"
                                ),
                                include.lowest = TRUE),
    taux_devenir_favorable=taux_en_formation+taux_en_emploi_6_mois,
    group_taux_en_devenir_favorable=case_when(
      taux_devenir_favorable<=72 & type_formation=="Avant le bac" ~ "Taux de devenir favorable faible",
      taux_devenir_favorable>72 & type_formation=="Avant le bac" ~ "Taux de devenir favorable pas faible",
      taux_devenir_favorable<=78 & type_formation=="Après le bac" ~ "Taux de devenir favorable faible",
      taux_devenir_favorable>78 & type_formation=="Après le bac" ~ "Taux de devenir favorable pas faible"
    ),
    group_taux_en_devenir_favorable_extreme=case_when(
      taux_devenir_favorable<=68 & type_formation=="Avant le bac" ~ "Taux de devenir favorable très faible",
      taux_devenir_favorable>68 & type_formation=="Avant le bac" ~ "Taux de devenir favorable pas très faible",
      taux_devenir_favorable<=72 & type_formation=="Après le bac" ~ "Taux de devenir favorable très faible",
      taux_devenir_favorable>72 & type_formation=="Après le bac" ~ "Taux de devenir favorable pas très faible"
    ),
    group_taux_en_devenir_favorable_extreme=factor(group_taux_en_devenir_favorable_extreme,levels=c("Taux de devenir favorable très faible","Taux de devenir favorable pas très faible")),
    Evolution_RDV_pct=(`2024 - RDV`/`2023 - RDV`)-1,
    Evolution_RDV_nb=`2024 - RDV`-`2023 - RDV`,
    Evolution_RDV=case_when(
      Evolution_RDV_pct< -0.01 ~ "Baisse",
      Evolution_RDV_pct > 0.01 ~"Hausse",
      Evolution_RDV_pct >= -0.01 & Evolution_RDV_pct <= 0.01 ~"Stable"
    ),
    Evolution_visiteurs_pct=(`2024 - visiteurs`/`2023 - visiteurs`)-1,
    Evolution_visiteurs_nb=`2024 - visiteurs`-`2023 - visiteurs`,
    Evolution_visiteurs=case_when(
      Evolution_visiteurs_pct< -0.01 ~ "Baisse",
      Evolution_visiteurs_pct > 0.01 ~"Hausse",
      Evolution_visiteurs_pct >= -0.01 & Evolution_visiteurs_pct <= 0.01 ~"Stable"
    ),
    `2023 - RDV/visiteur`=(`2023 - RDV`/`2023 - visiteurs`)*1000,
    `2024 - RDV/visiteur`=(`2024 - RDV`/`2024 - visiteurs`)*1000,
    Evolution_RDV_par_visiteur_pct=(`2024 - RDV/visiteur`/`2023 - RDV/visiteur`)-1,
    Evolution_RDV_par_visiteur_nb=`2024 - RDV/visiteur`-`2023 - RDV/visiteur`,
    Evolution_RDV_par_visiteur=case_when(
      Evolution_RDV_par_visiteur_pct< -0.01 ~ "Baisse",
      Evolution_RDV_par_visiteur_pct > 0.01 ~"Hausse",
      Evolution_RDV_par_visiteur_pct >= -0.01 & Evolution_RDV_par_visiteur_pct <= 0.01 ~"Stable"
    )
  )


nb_formations <- stats_lba_cle_rdv %>% 
    filter(Presence=="2023-2024") %>% 
    distinct(`Cle Ministere Educatif`) %>% 
    nrow()
```

## Les questions

   -    L'exposition des données InserJeunes et les demandes de rendez-vous sur LBA ont-elles un lien?
   -    De meilleurs/moins bons taux d’insertion / d’emploi signifient t-ils des volumes de demandes de rendez-vous différents?  

## Cadre des données analysées

Les données analysées sont issues de LBA et concernent toutes les fiches formations ayant été consultées sur LBA:  

-   Antre le 1er fevrier et le 28 avril des années 2023 et 2024  
-   Ayant un CFD et un UAI valide  
-   Présentes sur le catalogue des ministères éducatifs en 2023 et en 2024  


Les formations présentes en 2023 sont utilisées comme groupe témoin. Avant le 15 mai 2023, aucune formation ne bénéficiait de l'exposition des données InserJeunes. Nous analysons l'évolution des demandes de rendez-vous en fonction de différents facteurs:  

-   L'affichage des données InserJeunes en 2024  
-   Le niveau d'entrée: avant ou après le bac  
-   Le taux de devenir favorable  
-   Le taux en emploi à 6 mois  
-   Le taux en formation  

`r nb_formations` formations sont concernées par les demandes de rendez-vous selon les critères détaillés ci-dessus.

## Quelques statistiques descriptives 

### Visites sur la période

Pour ces formations, on constate une forte hausse de 180% des visites entre 2023 et 2024 (de 32010 en 2023 à 89471 en 2024) :  



```{r}
stats_lba_cle_rdv %>% 
  filter(Presence=="2023-2024") %>% 
  summarise(
    `2023 - visiteurs`=sum(`2023 - visiteurs`,na.rm = T),
    `2024 - visiteurs`=sum(`2024 - visiteurs`,na.rm = T)
  ) %>% 
  mutate(
    Evolution_visiteurs=case_when(
      .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
      T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
    )
  ) %>% 
  flextable() %>% 
  colformat_num(
  big.mark = " ", decimal.mark = ",",
  na_str = "N/A"
)
```

### Demandes de rendez-vous sur la période

Pour ces formations, on constate une légère hausse de 1% des demandes de rendez-vous entre 2023 et 2024 ( de 5099 en 2023 à 5126 en 2024) :  



```{r}
stats_lba_cle_rdv %>% 
  filter(Presence=="2023-2024") %>% 
  summarise(
    `2023 - RDV`=sum(`2023 - RDV`,na.rm = T),
    `2024 - RDV`=sum(`2024 - RDV`,na.rm = T)
  ) %>% 
  mutate(
    Evolution_RDV=case_when(
      .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
      T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
    )
  ) %>% 
  flextable() %>% 
  colformat_num(
  big.mark = " ", decimal.mark = ",",
  na_str = "N/A"
)
```

### Demandes de rendez-vous pour 1000 visites sur la période

Pour ces formations, on constate une baisse de  64% du nombre de demandes de rendez-vous pour 1000 visites entre 2023 et 2024 (de 159 en 2023 à 57.3 en 2024) :  



```{r}
stats_lba_cle_rdv %>% 
  filter(Presence=="2023-2024") %>% 
  summarise(
    `2023 - RDV`=sum(`2023 - RDV`,na.rm = T),
    `2024 - RDV`=sum(`2024 - RDV`,na.rm = T),
    `2023 - visiteurs`=sum(`2023 - visiteurs`,na.rm = T),
    `2024 - visiteurs`=sum(`2024 - visiteurs`,na.rm = T)
  )  %>% 
  mutate(
    `2023 - RDV pour 1000 visites`=`2023 - RDV`/`2023 - visiteurs` *1000,
    `2024 - RDV pour 1000 visites`=`2024 - RDV`/`2024 - visiteurs` *1000
  ) %>% 
  select(`2023 - RDV pour 1000 visites`,`2024 - RDV pour 1000 visites`) %>% 
  mutate(
    Evolution_rdv_pour_1000_visites=case_when(
      .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
      T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
    )
  )  %>% 
  flextable() %>% 
  colformat_num(
  big.mark = " ", decimal.mark = ",",
  na_str = "N/A"
)
```

## Lien avec l'affichage des données IJ

*   **Demandes de rendez-vous**: Lorsque les formations ont un affichage des données IJ en 2024, on constate une baisse de 24% des demandes de rendez-vous. A l'inverse, lorsque les données IJ ne sont pas disponibles en 2024, on constate une hausse de 74% des demandes de rendez-vous.  

*   **Visites**:  Lorsque les formations ont un affichage des données IJ en 2024, on constate une hausse de 135% des visites de fiches formation. Lorsque les données IJ ne sont pas disponibles en 2024, on constate que cette hausse est encore plus forte avec 251% entre les deux périodes.  

*   **Demandes de rendez-vous pour 1000 visites**:  Rapportées aux visites, les demandes de rendez-vous pour 1000 visites sont à la baisse que les données IJ soient exposées ou non. Cette baisse est néanmoins beaucoup plus marquée concernant les formations dont les données IJ sont exposées (-68% contre - 50%).  


```{r}
temp <- stats_lba_cle_rdv %>% 
  filter(Presence=="2023-2024") %>% 
  select(`2023 - RDV`, `2024 - RDV`,type_formation ,affichage_ij_2024) %>% 
  pivot_longer(cols = c(`2023 - RDV` ,`2024 - RDV`),names_to = "Periode",values_to = "RDV") %>% 
  group_by(Periode,affichage_ij_2024) %>% 
  summarise(RDV=sum(RDV,na.rm=T)) %>% 
  ungroup() %>% 
  mutate(affichage_ij_2024=factor(affichage_ij_2024,levels=c(T,F),labels=c("Oui","Non"))) %>% 
  rename("Affichage des données IJ en 2024"=affichage_ij_2024) %>% 
  pivot_wider(names_from = Periode,values_from = RDV) %>% 
  mutate(
    Evolution_RDV=case_when(
      .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
      T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
    )
  ) %>% 
  left_join(
    stats_lba_cle_rdv %>% 
      filter(Presence=="2023-2024") %>% 
      select(`2023 - visiteurs`, `2024 - visiteurs`,type_formation ,affichage_ij_2024) %>% 
      pivot_longer(cols = c(`2023 - visiteurs` ,`2024 - visiteurs`),names_to = "Periode",values_to = "visiteurs") %>% 
      group_by(Periode,affichage_ij_2024) %>% 
      summarise(visiteurs=sum(visiteurs,na.rm=T)) %>% 
      ungroup() %>% 
      mutate(affichage_ij_2024=factor(affichage_ij_2024,levels=c(T,F),labels=c("Oui","Non"))) %>% 
      rename("Affichage des données IJ en 2024"=affichage_ij_2024) %>% 
      pivot_wider(names_from = Periode,values_from = visiteurs) %>% 
      mutate(
        Evolution_visiteurs=case_when(
          .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
          T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
        )
      ),
    by=c("Affichage des données IJ en 2024")
  ) %>% 
  left_join(
    stats_lba_cle_rdv %>% 
      filter(Presence=="2023-2024") %>% 
      group_by(affichage_ij_2024) %>% 
      summarise(
        `2023 - RDV`=sum(`2023 - RDV`,na.rm = T),
        `2024 - RDV`=sum(`2024 - RDV`,na.rm = T),
        `2023 - visiteurs`=sum(`2023 - visiteurs`,na.rm = T),
        `2024 - visiteurs`=sum(`2024 - visiteurs`,na.rm = T)
      )  %>% 
      mutate(
      `2023 - RDV pour 1000 visites`=round(`2023 - RDV`/`2023 - visiteurs` *1000),
        `2024 - RDV pour 1000 visites`=round(`2024 - RDV`/`2024 - visiteurs` *1000)
      ) %>% 
      mutate(
        Evolution_rdv_pour_1000_visites=case_when(
          .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
          T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
        )
      ) %>% 
      select(affichage_ij_2024,`2023 - RDV pour 1000 visites`,`2024 - RDV pour 1000 visites`,Evolution_rdv_pour_1000_visites)%>% 
      ungroup() %>% 
      mutate(affichage_ij_2024=factor(affichage_ij_2024,levels=c(T,F),labels=c("Oui","Non"))) %>% 
      rename("Affichage des données IJ en 2024"=affichage_ij_2024),
    by=c("Affichage des données IJ en 2024")
  )


temp %>%
  flextable() %>% 
  set_header_labels(
    values = c("Affichage des données IJ en 2024",rep(c('2023', '2024',"Evolution"), 3))
  ) %>% 
  add_header_row(
    values = c("","Demandes de rdv", "Visites","Demandes de rdv pour 1000 visites"),
    colwidths = c(1, 3,3,3), top = TRUE
)%>% 
  colformat_num(
  big.mark = " ", decimal.mark = ",",
  na_str = "N/A"
)
```



## Lien avec le niveau de formation

*   **Demandes de rendez-vous**: Les formations infra-bac voient une hausse de 101% des demandes de rendez-vous entre 2023 et 2024. A l'inverse, les formations post-bac voient une baisse de 25% des demandes de rendez-vous entre 2023 et 2024.  

*   **Visites**: L'évolution des visites des fiches formation est assez proche entre les formations post-bac et infra-bac (resp. +175% et +187%).  

*   **Demandes de rendez-vous pour 1000 visites**: Il en découle une baisse beaucoup plus importante des demandes de rendez-vous pour 1000 visites concernant les formations post-bac (-73% vs -30%).  


```{r}
temp <- stats_lba_cle_rdv %>% 
  filter(Presence=="2023-2024") %>% 
  select(`2023 - RDV`, `2024 - RDV`,type_formation ,affichage_ij_2024,type_formation) %>% 
  pivot_longer(cols = c(`2023 - RDV` ,`2024 - RDV`),names_to = "Periode",values_to = "RDV") %>% 
  group_by(Periode,type_formation) %>% 
  summarise(RDV=sum(RDV,na.rm=T)) %>% 
  ungroup() %>%
  rename("Avant/Après le bac"=type_formation) %>%
  pivot_wider(names_from = Periode,values_from = RDV) %>% 
  mutate(
    Evolution_RDV=case_when(
      .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
      T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
    )
  ) %>% 
  left_join(
    stats_lba_cle_rdv %>% 
      filter(Presence=="2023-2024") %>% 
      select(`2023 - visiteurs`, `2024 - visiteurs`,type_formation ,affichage_ij_2024,type_formation) %>% 
      pivot_longer(cols = c(`2023 - visiteurs` ,`2024 - visiteurs`),names_to = "Periode",values_to = "visiteurs") %>% 
      group_by(Periode,type_formation) %>% 
      summarise(visiteurs=sum(visiteurs,na.rm=T)) %>% 
      ungroup() %>%
      rename("Avant/Après le bac"=type_formation) %>%
      pivot_wider(names_from = Periode,values_from = visiteurs) %>% 
      mutate(
        Evolution_visiteurs=case_when(
          .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
          T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
        )
      ),
    by=c("Avant/Après le bac")
  ) %>% 
  left_join(
    stats_lba_cle_rdv %>% 
      filter(Presence=="2023-2024") %>% 
      group_by(type_formation) %>% 
      summarise(
        `2023 - RDV`=sum(`2023 - RDV`,na.rm = T),
        `2024 - RDV`=sum(`2024 - RDV`,na.rm = T),
        `2023 - visiteurs`=sum(`2023 - visiteurs`,na.rm = T),
        `2024 - visiteurs`=sum(`2024 - visiteurs`,na.rm = T)
      )  %>% 
      mutate(
        `2023 - RDV pour 1000 visites`=round(`2023 - RDV`/`2023 - visiteurs` *1000),
        `2024 - RDV pour 1000 visites`=round(`2024 - RDV`/`2024 - visiteurs` *1000)
      ) %>% 
      mutate(
        Evolution_rdv_pour_1000_visites=case_when(
          .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
          T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
        )
      ) %>% 
      select(type_formation,`2023 - RDV pour 1000 visites`,`2024 - RDV pour 1000 visites`,Evolution_rdv_pour_1000_visites)%>% 
      ungroup() %>% 
      rename("Avant/Après le bac"=type_formation),
      by=c("Avant/Après le bac")
  )


temp %>%
  flextable() %>% 
  set_header_labels(
    values = c("Avant/Après le bac",rep(c('2023', '2024',"Evolution"), 3))
  ) %>% 
  add_header_row(
    values = c("","Demandes de rdv", "Visites","Demandes de rdv pour 1000 visites"),
    colwidths = c(1, 3,3,3), top = TRUE
) %>% 
  colformat_num(
  big.mark = " ", decimal.mark = ",",
  na_str = "N/A"
)
```

### Demandes de rendez-vous pour 1000 visites sur la période

## Lien avec l'affichage des données IJ et le niveau de formation

*   **Demandes de rendez-vous**: Sans affichage de donneés IJ, la hause concerne les formations post et infra-bac même si on constate une plus forte hausse pour l'infra-bac (+209% contre +57%). 
A l'inverse, avec affichage des données IJ les formations post-bac voient une baisse de 56% des demandes de rendez-vous entre 2023 et 2024 alors que dans le même temps les formations infra-bac voient une hausse de 84% des demandes de rendez-vous. Cette hauuse est néanmoins inférieure à celle observée pour les formations infra-bac sans affichage de données IJ. 

*   **Visites**: Sans affichage de données IJ, l'évolution du nombre de visites est en hausse et relativement similaire pour les formations post et infra-bac (~ +250%). En revanche, cette hausse est pluys marquée pour les formations infra-bac ayant un affichage de données IJ que pour les formations post-bac ayant un affichage des données IJ (+167% vs +109%).    

*   **Demandes de rendez-vous pour 1000 visites**:  Ainsi, les formations infra-bac sans affichage de données IJ ont une baisse moins importante des demandes de rendez-vous pour 1000 visites que les formations infra-bac avec exposition des données IJ. Il en va de même pour les formations post-bac.  


```{r}
temp <- stats_lba_cle_rdv %>% 
  filter(Presence=="2023-2024") %>% 
  select(`2023 - RDV`, `2024 - RDV`,type_formation ,affichage_ij_2024,type_formation) %>% 
  pivot_longer(cols = c(`2023 - RDV` ,`2024 - RDV`),names_to = "Periode",values_to = "RDV") %>% 
  group_by(affichage_ij_2024,Periode,type_formation) %>% 
  summarise(RDV=sum(RDV,na.rm=T)) %>% 
  ungroup() %>% 
  mutate(affichage_ij_2024=factor(affichage_ij_2024,levels=c(T,F),labels=c("Oui","Non"))) %>% 
  rename("Affichage des données IJ en 2024"=affichage_ij_2024,
         "Avant/Après le bac"=type_formation) %>% 
  
  pivot_wider(names_from = Periode,values_from = RDV) %>% 
  ungroup() %>% 
  mutate(
    Evolution_RDV=case_when(
      .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
      T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
    )
  ) %>% 
  left_join(
    stats_lba_cle_rdv %>% 
      filter(Presence=="2023-2024") %>% 
      select(`2023 - visiteurs`, `2024 - visiteurs`,type_formation ,affichage_ij_2024,type_formation) %>% 
      pivot_longer(cols = c(`2023 - visiteurs` ,`2024 - visiteurs`),names_to = "Periode",values_to = "visiteurs") %>% 
      group_by(affichage_ij_2024,Periode,type_formation) %>% 
      summarise(visiteurs=sum(visiteurs,na.rm=T)) %>% 
      ungroup() %>% 
      mutate(affichage_ij_2024=factor(affichage_ij_2024,levels=c(T,F),labels=c("Oui","Non"))) %>% 
      rename("Affichage des données IJ en 2024"=affichage_ij_2024,
             "Avant/Après le bac"=type_formation) %>% 
      
      pivot_wider(names_from = Periode,values_from = visiteurs) %>% 
      ungroup() %>% 
      mutate(
        Evolution_visiteurs=case_when(
          .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
          T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
        )
      ),
    by=c("Avant/Après le bac","Affichage des données IJ en 2024")
  ) %>% 
  left_join(
    stats_lba_cle_rdv %>% 
      filter(Presence=="2023-2024") %>% 
      group_by(type_formation,affichage_ij_2024) %>% 
      summarise(
        `2023 - RDV`=sum(`2023 - RDV`,na.rm = T),
        `2024 - RDV`=sum(`2024 - RDV`,na.rm = T),
        `2023 - visiteurs`=sum(`2023 - visiteurs`,na.rm = T),
        `2024 - visiteurs`=sum(`2024 - visiteurs`,na.rm = T)
      )  %>% 
      mutate(
        `2023 - RDV pour 1000 visites`=round(`2023 - RDV`/`2023 - visiteurs` *1000),
        `2024 - RDV pour 1000 visites`=round(`2024 - RDV`/`2024 - visiteurs` *1000)
      ) %>%
      ungroup() %>% 
      mutate(
        Evolution_rdv_pour_1000_visites=case_when(
          .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
          T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
        )
      ) %>% 
      select(type_formation,affichage_ij_2024,`2023 - RDV pour 1000 visites`,`2024 - RDV pour 1000 visites`,Evolution_rdv_pour_1000_visites)%>%
      mutate(affichage_ij_2024=factor(affichage_ij_2024,levels=c(T,F),labels=c("Oui","Non"))) %>% 
      rename("Affichage des données IJ en 2024"=affichage_ij_2024,
             "Avant/Après le bac"=type_formation),
    by=c("Avant/Après le bac","Affichage des données IJ en 2024")
  )



temp %>%
  flextable() %>% 
  set_header_labels(
    values = c("Affichage des données IJ en 2024","Avant/Après le bac",rep(c('2023', '2024',"Evolution"), 3))
  ) %>% 
  add_header_row(
    values = c("","","Demandes de rdv", "Visites","Demandes de rdv pour 1000 visites"),
    colwidths = c(1,1,3,3,3), top = TRUE
)%>% 
  colformat_num(
  big.mark = " ", decimal.mark = ",",
  na_str = "N/A"
)

```


## Zoom sur les formations ayant un affichage de données IJ en 2024

### Lien avec le niveau de formation et le taux de devenir favorable

```{r satats_descriptives_dev_favorable}
# stats_lba_cle_rdv %>%
#   filter(!is.na(type_formation)) %>%
#   group_by(type_formation) %>%
#   summarise(
#     min_dev_fav=quantile(taux_devenir_favorable,0,na.rm=T),
#     q10_dev_fav=quantile(taux_devenir_favorable,0.1,na.rm=T),
#     q25_dev_fav=quantile(taux_devenir_favorable,0.25,na.rm=T),
#     q50_dev_fav=quantile(taux_devenir_favorable,0.5,na.rm=T),
#     q75_dev_fav=quantile(taux_devenir_favorable,0.75,na.rm=T),
#     q90_dev_fav=quantile(taux_devenir_favorable,0.9,na.rm=T),
#     max_dev_fav=quantile(taux_devenir_favorable,1,na.rm=T)
#   ) %>%
#   mutate(type_formation=as.character(type_formation)) %>%
#   setNames(c("Avant/Après le bac","min","Q10","Q25","Mediane","Q75","Q90","Max")) %>%
#   bind_rows(
#     stats_lba_cle_rdv %>%
#       filter(!is.na(type_formation)) %>%
#       summarise(
#         min_dev_fav=quantile(taux_devenir_favorable,0,na.rm=T),
#         q10_dev_fav=quantile(taux_devenir_favorable,0.1,na.rm=T),
#         q25_dev_fav=quantile(taux_devenir_favorable,0.25,na.rm=T),
#         q50_dev_fav=quantile(taux_devenir_favorable,0.5,na.rm=T),
#         q75_dev_fav=quantile(taux_devenir_favorable,0.75,na.rm=T),
#         q90_dev_fav=quantile(taux_devenir_favorable,0.9,na.rm=T),
#         max_dev_fav=quantile(taux_devenir_favorable,1,na.rm=T)
#       ) %>%
#       mutate(type_formation="Total") %>%
#       setNames(c("min","Q10","Q25","Mediane","Q75","Q90","Max","Avant/Après le bac"))
#   ) %>%
#   knitr::kable()
```


```{r distribution_taux_devenir}
# ggplot(stats_lba_cle_rdv %>% 
#          filter(Presence=="2023-2024",affichage_ij_2024 ), aes(x=taux_devenir_favorable, color = type_formation)) +
#   geom_density(size=1.2)+
#   geom_vline(xintercept = 66,color="#440154FF",linetype="dotted",size=1)+
#   geom_vline(xintercept = 72,color="#21908CFF",size=1)+
#   geom_vline(xintercept = 72,color="#440154FF",linetype="dotted",size=1)+
#   geom_vline(xintercept = 78,color="#21908CFF",linetype="dotted",size=1)+
#   annotate("text",x=63,y=0.075,label = "66%",angle=90,color="red")+
#   annotate("text",x=69,y=0.075,label = "72%",angle=90,color="red")+
#   annotate("text",x=75,y=0.075,label = "78%",angle=90,color="red")+
#   scale_y_continuous(labels = scales::label_percent())+
#   scale_colour_manual("Type de formation",values=c("#440154FF","#21908CFF"))+
#   labs(x="Taux de devenir favorable",y="Densité",
#        title = "Distribution du taux de devenir favorable",
#        subtitle = "Densité des formations en fonction taux de devenir favorable"
#   )
```

<!--10% des formations ont un taux de devenir favorable inférieur à 68% et 25% des formations ont un taux de devenir favorable inférieur à 74%.

Un taux de devenir favorable faible (Q25: premier quartile) correspond à une valeur de 72% pour l’infra-bac et 78% pour le post-bac.-->

L'arbre de décision suivant tend à montrer que les utilisateurs demandent plus de rendez-vous lorsque le taux de devenir favorable est compris entre 73 et 83%.

```{r}
data_rpart <- stats_lba_cle_rdv %>% 
  filter(Presence=="2023-2024",affichage_ij_2024) %>% 
  filter(Evolution_RDV_par_visiteur!="Stable") %>% 
  mutate(Evolution_RDV_par_visiteur=factor(Evolution_RDV_par_visiteur,levels=c("Baisse","Hausse"))) 

model <- rpart(Evolution_RDV_par_visiteur ~ taux_devenir_favorable, data = data_rpart)
rpart.plot(model,main="Arbre de décision:\nEvolution du nombre de rdv pour 1000 visites\nen fonction du taux de devenir favorable") 

stats_lba_cle_rdv <- stats_lba_cle_rdv %>% 
  mutate(group_taux_en_devenir_favorable=case_when(
    taux_devenir_favorable>=83 | taux_devenir_favorable<73 ~"Taux de devenir favorable supérieur à 83% ou inférieur à 73%",
    taux_devenir_favorable<83|taux_devenir_favorable>=73 ~"Taux de devenir favorable compris entre 73 et 83%"
  ))
  
```


```{r}
temp <- stats_lba_cle_rdv %>%
  filter(Presence=="2023-2024",affichage_ij_2024 )  %>%
  select(`2023 - RDV`, `2024 - RDV`,type_formation ,group_taux_en_devenir_favorable,type_formation) %>%
  pivot_longer(cols = c(`2023 - RDV` ,`2024 - RDV`),names_to = "Periode",values_to = "RDV") %>%
  group_by(type_formation,group_taux_en_devenir_favorable,Periode) %>%
  summarise(RDV=sum(RDV,na.rm=T)) %>%
  pivot_wider(names_from = Periode,values_from = RDV) %>%
  ungroup() %>%
  rename("Avant/Après le bac"=type_formation,
         "Groupe de taux de devenir favorable"=group_taux_en_devenir_favorable) %>%
  mutate(
    Evolution=case_when(
      .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
      T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
    )
  ) %>%
  left_join(
    stats_lba_cle_rdv %>%
      filter(Presence=="2023-2024",affichage_ij_2024 )  %>%
      select(`2023 - visiteurs`, `2024 - visiteurs`,type_formation ,group_taux_en_devenir_favorable,type_formation) %>%
      pivot_longer(cols = c(`2023 - visiteurs` ,`2024 - visiteurs`),names_to = "Periode",values_to = "visiteurs") %>%
      group_by(type_formation,group_taux_en_devenir_favorable,Periode) %>%
      summarise(visiteurs=sum(visiteurs,na.rm=T)) %>%
      pivot_wider(names_from = Periode,values_from = visiteurs) %>%
      ungroup() %>%
      rename("Avant/Après le bac"=type_formation,
             "Groupe de taux de devenir favorable"=group_taux_en_devenir_favorable) %>%
      mutate(
        Evolution=case_when(
          .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
          T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
        )
      ),
    by=c("Avant/Après le bac","Groupe de taux de devenir favorable")
  ) %>%
  left_join(
    stats_lba_cle_rdv %>%
      filter(Presence=="2023-2024",affichage_ij_2024 )  %>%
      group_by(type_formation,group_taux_en_devenir_favorable) %>%
      summarise(
        `2023 - RDV`=sum(`2023 - RDV`,na.rm = T),
        `2024 - RDV`=sum(`2024 - RDV`,na.rm = T),
        `2023 - visiteurs`=sum(`2023 - visiteurs`,na.rm = T),
        `2024 - visiteurs`=sum(`2024 - visiteurs`,na.rm = T)
      )  %>%
      mutate(
        `2023 - RDV pour 1000 visites`=round(`2023 - RDV`/`2023 - visiteurs` *1000),
        `2024 - RDV pour 1000 visites`=round(`2024 - RDV`/`2024 - visiteurs` *1000)
      ) %>%
      ungroup() %>%
      mutate(
        Evolution_rdv_pour_1000_visites=case_when(
          .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
          T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
        )
      ) %>%
      select(type_formation,group_taux_en_devenir_favorable      ,`2023 - RDV pour 1000 visites`,`2024 - RDV pour 1000 visites`,Evolution_rdv_pour_1000_visites)%>%
      rename("Avant/Après le bac"=type_formation,
             "Groupe de taux de devenir favorable"=group_taux_en_devenir_favorable),
      by=c("Avant/Après le bac","Groupe de taux de devenir favorable")
  )


temp %>%
  flextable() %>% 
  set_header_labels(
    values = c("Avant/Après le bac","Groupe de taux de devenir favorable",rep(c('2023', '2024',"Evolution"), 3))
  ) %>% 
  add_header_row(
    values = c("","","Demandes de rdv", "Visites","Demandes de rdv pour 1000 visites"),
    colwidths = c(1,1,3,3,3), top = TRUE
)%>% 
  colformat_num(
  big.mark = " ", decimal.mark = ",",
  na_str = "N/A"
)
```



<!--*   **Demandes de rendez-vous**: Le premier quartile de taux de devenir favorable (72% pour l’infra-bac et 78% pour le post-bac) est discriminant pour les formations infra et post-bac. 

**Deux constats relativement proches à nuancer néanmoins:**

- **Pour les formations infra-bac:**
    
    Il y a une hausse plus importante des demandes de rendez-vous pour les formations ayant un faible taux de devenir favorable.
    
- **Pour les formations post-bac:**
    
    Il y a une baisse moins importante des demandes de rendez-vous pour les formations ayant un faible taux de devenir favorable.
    

Les formations post-bac ayant un faible taux de devenir favorable voient une baisse moins importante qu’au dessus de ce seuil (-56% contre -67%). De la même façon, concernant l’infra-bac, on constate une hausse plus importante des demandes de rendez-vous pour les formations ayant un faible taux de devenir favorable (+86% contre +27%).  

*   **Visites**:  
*   **Demandes de rendez-vous pour 1000 visites**:  



Explications possibles : 

1. Les futurs lycéens et étudiants sont peut-être plus dans une zone d’incertitude (incompréhension des données ou besoin de davantage d’informations) en dessous de 74% et sollicitent alors les établissements pour plus de renseignements.
2. Les vœux sur les plateformes d’affectation sont corrélés aux demandes de rendez-vous : il y a moins de demandes de rendez-vous car ce sont des formations qui intéressent moins.


En abaissant le seuil du taux de devenir favorable au 10ème quantile (Q10), le phénomène observé au seuil faible (Q25) s’accentue. Il y a une plus forte hausse des demandes de rendez-vous pour les formations post-bac ayant un très faible taux de devenir favorable et la baisse des demandes de rendez-vous est moins 
-->

```{r}

# stats_lba_cle_rdv %>% 
#   filter(Presence=="2023-2024",affichage_ij_2024 )  %>% 
#   select(`2023 - RDV`, `2024 - RDV`,type_formation ,group_taux_en_devenir_favorable_extreme,type_formation) %>% 
#   pivot_longer(cols = c(`2023 - RDV` ,`2024 - RDV`),names_to = "Periode",values_to = "RDV") %>% 
#   group_by(type_formation,group_taux_en_devenir_favorable_extreme,Periode) %>% 
#   summarise(RDV=sum(RDV,na.rm=T)) %>%  
#   pivot_wider(names_from = Periode,values_from = RDV) %>% 
#   ungroup() %>% 
#   rename("Avant/Après le bac"=type_formation) %>%
#   mutate(
#     Evolution=case_when(
#       .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
#       T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
#     )
#   ) %>% 
#   knitr::kable()
```

### Lien avec le niveau de formation, le taux en emploi à 6 mois et le taux en formation

L'arbre de décision ci-dessous tend à montrer que le nombre de demandes de rendez-vous est en baisse si:  

*   Le taux en formation est supérieur ou égal à 23%,   
*   Le taux en emploi à 6 mois est suprieur ou égal à 81%,  
*   Le taux en formation est compris entre 15 et 23% et taux en emploi à 6 mois est compris entre 57 et 81%.  


```{r}
model <- rpart(Evolution_RDV_par_visiteur ~ taux_en_emploi_6_mois + taux_en_formation, data = data_rpart)
rpart.plot(model)

stats_lba_cle_rdv <- stats_lba_cle_rdv %>% 
  mutate(
    group_taux_en_emploi_6_mois_en_formation=case_when(
    taux_en_emploi_6_mois>=81 ~"Taux en empoi à 6 mois >= 81%, taux en formation >= 23 ou taux en formation est compris entre 15 et 23% et taux en emploi à 6 mois est compris entre 57 et 81%",
    taux_en_formation>=23 ~"Taux en empoi à 6 mois >= 81%, taux en formation >= 23 ou taux en formation est compris entre 15 et 23% et taux en emploi à 6 mois est compris entre 57 et 81%",
    taux_en_emploi_6_mois>=57 & taux_en_formation>=15 ~ "Taux en empoi à 6 mois >= 81%, taux en formation >= 23 ou taux en formation est compris entre 15 et 23% et taux en emploi à 6 mois est compris entre 57 et 81%",
    T~"Autres"
  ))

```



```{r}
temp <-stats_lba_cle_rdv %>% 
  filter(Presence=="2023-2024",affichage_ij_2024 )  %>% 
  select(`2023 - RDV`, `2024 - RDV`,type_formation ,group_taux_en_emploi_6_mois_en_formation,type_formation) %>% 
  pivot_longer(cols = c(`2023 - RDV` ,`2024 - RDV`),names_to = "Periode",values_to = "RDV") %>% 
  group_by(type_formation,group_taux_en_emploi_6_mois_en_formation,Periode) %>% 
  summarise(RDV=sum(RDV,na.rm=T)) %>%  
  pivot_wider(names_from = Periode,values_from = RDV) %>% 
  ungroup() %>% 
  rename("Avant/Après le bac"=type_formation,
         "Groupe de taux de devenir favorable"=group_taux_en_emploi_6_mois_en_formation) %>%
  mutate(
    Evolution=case_when(
      .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
      T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
    )
  ) %>% 
  left_join(
    stats_lba_cle_rdv %>% 
      filter(Presence=="2023-2024",affichage_ij_2024 )  %>% 
      select(`2023 - visiteurs`, `2024 - visiteurs`,type_formation ,group_taux_en_emploi_6_mois_en_formation,type_formation) %>% 
      pivot_longer(cols = c(`2023 - visiteurs` ,`2024 - visiteurs`),names_to = "Periode",values_to = "visiteurs") %>% 
      group_by(type_formation,group_taux_en_emploi_6_mois_en_formation,Periode) %>% 
      summarise(visiteurs=sum(visiteurs,na.rm=T)) %>%  
      pivot_wider(names_from = Periode,values_from = visiteurs) %>% 
      ungroup() %>% 
      rename("Avant/Après le bac"=type_formation,
             "Groupe de taux de devenir favorable"=group_taux_en_emploi_6_mois_en_formation) %>%
      mutate(
        Evolution=case_when(
          .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
          T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
        )
      ),
    by=c("Avant/Après le bac","Groupe de taux de devenir favorable")
  ) %>% 
  left_join(
    stats_lba_cle_rdv %>% 
      filter(Presence=="2023-2024",affichage_ij_2024 )  %>% 
      group_by(type_formation,group_taux_en_emploi_6_mois_en_formation) %>% 
      summarise(
        `2023 - RDV`=sum(`2023 - RDV`,na.rm = T),
        `2024 - RDV`=sum(`2024 - RDV`,na.rm = T),
        `2023 - visiteurs`=sum(`2023 - visiteurs`,na.rm = T),
        `2024 - visiteurs`=sum(`2024 - visiteurs`,na.rm = T)
      )  %>% 
      mutate(
        `2023 - RDV pour 1000 visites`=round(`2023 - RDV`/`2023 - visiteurs` *1000),
        `2024 - RDV pour 1000 visites`=round(`2024 - RDV`/`2024 - visiteurs` *1000)
      ) %>%
      ungroup() %>% 
      mutate(
        Evolution_rdv_pour_1000_visites=case_when(
          .[[length(.)]]>.[[length(.)-1]] ~ paste0("+",scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))),
          T~scales::percent(((.[[length(.)]]/.[[length(.)-1]])-1))
        )
      ) %>% 
      select(type_formation,group_taux_en_emploi_6_mois_en_formation      ,`2023 - RDV pour 1000 visites`,`2024 - RDV pour 1000 visites`,Evolution_rdv_pour_1000_visites)%>%
      rename("Avant/Après le bac"=type_formation,
             "Groupe de taux de devenir favorable"=group_taux_en_emploi_6_mois_en_formation),
      by=c("Avant/Après le bac","Groupe de taux de devenir favorable")
  )


temp %>%
  flextable() %>% 
  set_header_labels(
    values = c("Avant/Après le bac","Groupe de taux en emploi et en formation",rep(c('2023', '2024',"Evolution"), 3))
  ) %>% 
  add_header_row(
    values = c("","","Demandes de rdv", "Visites","Demandes de rdv pour 1000 visites"),
    colwidths = c(1,1,3,3,3), top = TRUE
)%>% 
  colformat_num(
  big.mark = " ", decimal.mark = ",",
  na_str = "N/A"
)

```
