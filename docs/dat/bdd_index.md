# Stratégie d'Indexation de la Base de Données MongoDB

## Introduction

Ce document détaille la stratégie d'indexation mise en place pour garantir les performances de l'API Exposition. Les index sont un composant critique de l'architecture des données, car ils permettent des temps de réponse rapides pour les requêtes de lecture.

Tous les index sont définis et gérés sous forme de code via des scripts de migration **`migrate-mongo`**, assurant ainsi leur cohérence à travers les environnements. La source de vérité pour cette liste est le répertoire [`server/src/common/db/collections/`](/server/src/common/db/collections).

**Syntaxe des clés :**

- `{ "champ": 1 }` : Index ascendant sur le champ.
- `{ "champ": -1 }` : Index descendant sur le champ.

## Tableau des Index Principaux

| Collection                             | Index Definition (Keys)                                           | Type d'Index                                      | Justification / Route API supportée                                                                     |
| :------------------------------------- | :---------------------------------------------------------------- | :------------------------------------------------ | :------------------------------------------------------------------------------------------------------ |
| **`certificationsStats`**              | `millesime: 1`                                                    | Simple                                            | Accélère les requêtes filtrant par année (millésime).                                                   |
|                                        | `code_certification: 1`                                           | Simple                                            | Optimise la recherche par code de certification.                                                        |
|                                        | `code_formation_diplome: 1`                                       | Simple                                            | Optimise la recherche par code formation diplome.                                                       |
|                                        | `code_certification: 1`<br />`millesime: 1`                       | Composé, **Unique**                               | Garantie l'unicité et optimise la recherche d'indicateurs pour une certification et un millésime.       |
| **`regionalesStats`**                  | `millesime: 1`                                                    | Simple                                            | Accélère les requêtes filtrant par année (millésime).                                                   |
|                                        | `code_certification: 1`                                           | Simple                                            | Optimise la recherche par code de certification.                                                        |
|                                        | `code_formation_diplome: 1`                                       | Simple                                            | Optimise la recherche par code formation diplome.                                                       |
|                                        | `region.code: 1`                                                  | Simple                                            | Optimise la recherche par région.                                                                       |
|                                        | `region.code: 1`<br />`code_certification: 1`<br />`millesime: 1` | Composé, **Unique**                               | Garantie l'unicité et optimise la recherche d'indicateurs pour une certification, un UAI et une région. |
| **`bcn`**                              | `code_certification: 1`, **Unique**                               | Simple                                            | Garantit l'unicité d'une certification et optimise la recherche par code de certification.              |
|                                        | `code_formation_diplome: 1`                                       | Simple                                            | Optimise la recherche par code formation diplome.                                                       |
| **`bcn_mef`**                          | `mef_stat_11: 1`, **Unique**                                      | Simple                                            | Garantit l'unicité d'un MEFSTAT11 et optimise la recherche par MEFSTAT11.                               |
|                                        | `mef: 1`                                                          | Simple                                            | Optimise la recherche par mef.                                                                          |
| **`bcn_sise`**                         | `diplome_sise: 1`, **Unique**                                     | Simple                                            | Garantit l'unicité d'un SISE et optimise la recherche par SISE.                                         |
| **`catalogueApprentissageFormations`** | `id: 1`                                                           | Simple, **Unique**                                | Garantie l'unicité d'un id (id du catalogue de l'apprentissage) et optimise la recherche.               |
|                                        | `uai_formation: 1`                                                | Simple                                            | Optimise la recherche par UAI.                                                                          |
|                                        | `etablissement_gestionnaire_uai: 1`                               | Simple                                            | Optimise la recherche par UAI.                                                                          |
|                                        | `etablissement_formateur_uai: 1`                                  | Simple                                            | Optimise la recherche par UAI.                                                                          |
|                                        | `cfd: 1`                                                          | Simple                                            | Optimise la recherche par code formation diplome.                                                       |
|                                        | `cfd: 1`<br />`uai: 1`                                            | Composé                                           | Optimise la recherche par code formation diplome et UAI                                                 |
|                                        | `cfd: 1`<br />`etablissement_gestionnaire_uai: 1`                 | Composé                                           | Optimise la recherche par code formation diplome et UAI                                                 |
|                                        | `cfd: 1`<br />`etablissement_formateur_uai: 1`                    | Composé                                           | Optimise la recherche par code formation diplome et UAI                                                 |
| **`users`**                            | `username: 1`                                                     | Simple, **Unique**                                | Garantit l'unicité des username et optimise la recherche de l'utilisateur lors du login.                |
| **`logs`**                             | `time: 1`                                                         | Simple                                            | Optimise la recherche par date.                                                                         |
| **`metrics`**                          | `time: 1, consumer: 1, url: 1`                                    | Composé, **Unique**                               | Garantie l'unicité d'une métrique.                                                                      |
|                                        | `time: 1`                                                         | Simple avec expiration (expireAfterSeconds ~1 an) | Optimise la recherche par date et permet de supprimer les métriques expirées.                           |
|                                        | `consumer: 1`                                                     | Simple                                            | Optimise la recherche par consumer (IP ou domaine).                                                     |
|                                        | `user: 1`                                                         | Simple                                            | Optimise la recherche par utilisateur.                                                                  |
|                                        | `url: 1`                                                          | Simple                                            | Optimise la recherche par url.                                                                          |
|                                        | `uai: 1`                                                          | Simple                                            | Optimise la recherche par UAI.                                                                          |
|                                        | `extension: 1`                                                    | Simple                                            | Optimise la recherche par extension (json, svg).                                                        |
|                                        | `code_certification: 1`                                           | Simple                                            | Optimise la recherche par code certification.                                                           |
|                                        | `codes_certifications: 1`                                         | Simple                                            | Optimise la recherche par code certification.                                                           |
|                                        | `regions: 1`                                                      | Simple                                            | Optimise la recherche par région.                                                                       |
